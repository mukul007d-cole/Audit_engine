<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call Audit Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7f9;
      padding: 40px;
    }
    .layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
      max-width: 980px;
    }
    .box {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h2 { margin-top: 0; }
    input[type="file"], input[type="text"] {
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 16px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 6px;
    }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .status { margin-top: 12px; font-size: 14px; }
    .error { color: #dc2626; }
    .success { color: #16a34a; }
    .hint { font-size: 12px; color: #6b7280; }
    .job-card {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 13px;
      background: #fafafa;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .queued { background: #fef3c7; color: #92400e; }
    .processing { background: #dbeafe; color: #1e40af; }
    .completed { background: #dcfce7; color: #166534; }
    .failed { background: #fee2e2; color: #991b1b; }
    pre {
      white-space: pre-wrap;
      background: #111827;
      color: #f9fafb;
      padding: 10px;
      border-radius: 6px;
      max-height: 220px;
      overflow: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="box">
      <h2>Upload Call Recording</h2>
      <form id="uploadForm">
        <label for="sellerId">Seller ID</label>
        <input type="text" id="sellerId" name="sellerId" placeholder="e.g. seller-102" required />

        <label for="audio">Audio File</label>
        <input type="file" name="audio" id="audio" accept=".wav,.mp3,.mpeg,.mpga,.m4a,.ogg,.webm" required />

        <div class="hint">Supported formats: WAV, MP3, MPEG, MPGA, M4A, OGG, WEBM</div>
        <button type="submit" id="submitBtn">Upload (Async)</button>
      </form>

      <div id="status" class="status"></div>
      <div id="currentJob" class="status"></div>
    </div>

    <div class="box">
      <h2>Seller Job Dashboard</h2>
      <button id="refreshBtn">Refresh Jobs</button>
      <div id="jobsList" class="status"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const statusEl = document.getElementById("status");
    const currentJobEl = document.getElementById("currentJob");
    const jobsListEl = document.getElementById("jobsList");
    const btn = document.getElementById("submitBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const sellerIdEl = document.getElementById("sellerId");

    let pollHandle = null;

    function statusBadge(status) {
      return `<span class="badge ${status}">${status}</span>`;
    }

    async function fetchSellerJobs() {
      const sellerId = sellerIdEl.value.trim();
      if (!sellerId) {
        jobsListEl.innerHTML = "Enter seller ID to see job history.";
        return;
      }

      const res = await fetch(`/sellers/${encodeURIComponent(sellerId)}/jobs`);
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "Could not fetch seller jobs");
      }

      if (!data.jobs.length) {
        jobsListEl.innerHTML = "No jobs yet for this seller.";
        return;
      }

      jobsListEl.innerHTML = data.jobs
        .map((job) => `
          <div class="job-card">
            <div><b>Job:</b> ${job.id}</div>
            <div><b>Status:</b> ${statusBadge(job.status)}</div>
            <div><b>File:</b> ${job.fileName}</div>
            <div><b>Created:</b> ${job.createdAt}</div>
            ${job.pdf ? `<div><a href="${job.pdf}" target="_blank">Open PDF</a></div>` : ""}
            ${job.error ? `<div class="error"><b>Error:</b> ${job.error}</div>` : ""}
          </div>
        `)
        .join("");
    }

    async function monitorJob(jobId) {
      if (pollHandle) clearInterval(pollHandle);

      async function poll() {
        const res = await fetch(`/jobs/${jobId}`);
        const data = await res.json();

        if (!res.ok) {
          currentJobEl.innerHTML = `<span class="error">${data.error || "Job fetch failed"}</span>`;
          return;
        }

        const job = data.job;
        currentJobEl.innerHTML = `
          <div class="job-card">
            <div><b>Current Job:</b> ${job.id}</div>
            <div><b>Status:</b> ${statusBadge(job.status)}</div>
            ${job.pdf ? `<div><a href="${job.pdf}" target="_blank">Open Audit PDF</a></div>` : ""}
            ${job.error ? `<div class="error">${job.error}</div>` : ""}
          </div>
          ${job.report ? `<pre>${JSON.stringify(job.report, null, 2)}</pre>` : ""}
        `;

        if (job.status === "completed" || job.status === "failed") {
          clearInterval(pollHandle);
          pollHandle = null;
          btn.disabled = false;
          await fetchSellerJobs();
        }
      }

      await poll();
      pollHandle = setInterval(poll, 3000);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById("audio");
      const file = fileInput.files[0];
      const sellerId = sellerIdEl.value.trim();

      if (!sellerId) {
        statusEl.textContent = "Seller ID is required.";
        statusEl.className = "status error";
        return;
      }

      if (!file) {
        statusEl.textContent = "Please select an audio file.";
        statusEl.className = "status error";
        return;
      }

      const maxSizeMB = 50;
      if (file.size > maxSizeMB * 1024 * 1024) {
        statusEl.textContent = "File too large. Max 50MB allowed.";
        statusEl.className = "status error";
        return;
      }

      statusEl.textContent = "Upload accepted. Background processing started...";
      statusEl.className = "status";
      currentJobEl.textContent = "";
      btn.disabled = true;

      const formData = new FormData();
      formData.append("audio", file);
      formData.append("sellerId", sellerId);

      try {
        const res = await fetch("/jobs", { method: "POST", body: formData });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || "Upload failed");
        }

        statusEl.innerHTML = `<span class="success">Upload successful. Job queued: ${data.job.id}</span>`;
        await monitorJob(data.job.id);
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className = "status error";
        btn.disabled = false;
      }
    });

    refreshBtn.addEventListener("click", async () => {
      try {
        await fetchSellerJobs();
      } catch (err) {
        jobsListEl.innerHTML = `<span class="error">${err.message}</span>`;
      }
    });
  </script>
</body>
</html>
